{"ast":null,"code":"import _objectSpread from\"/Users/sebastianmolano/NebulaE/Projects/GTPC/dicon-audit-pwa/frontend/dicon-audit-pwa/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/objectSpread2\";import _createForOfIteratorHelper from\"/Users/sebastianmolano/NebulaE/Projects/GTPC/dicon-audit-pwa/frontend/dicon-audit-pwa/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/createForOfIteratorHelper\";import _ from'lodash';import{getDistance}from'geolib';var findRadioPermissibleError=function findRadioPermissibleError(dop){var dopDistancePermissibleErrors=arguments.length>1&&arguments[1]!==undefined?arguments[1]:[];var permissibleError=dopDistancePermissibleErrors.find(function(_ref){var dopInitial=_ref.dopInitial,dopFinal=_ref.dopFinal,radio=_ref.radio;return dop>=dopInitial&&dop<=dopFinal;});return permissibleError?permissibleError.radio:0;};var formatEventData=function formatEventData(event){if(event.__formatted)return;var year=event.fecha.slice(0,4);var month=event.fecha.slice(4,6);var day=event.fecha.slice(6,8);var hour=event.hora.slice(0,2);var minute=event.hora.slice(2,4);var second=event.hora.slice(4,6);var timestamp=new Date(\"\".concat(year,\"-\").concat(month,\"-\").concat(day,\"T\").concat(hour,\":\").concat(minute,\":\").concat(second,\"-05:00\")).getTime();event.timestamp=timestamp;event.dop=parseFloat(event.dop.replace(',','.'));event.longitud=parseFloat(event.longitud.replace(',','.'));event.latitud=parseFloat(event.latitud.replace(',','.'));event.__formatted=true;};var findCounterpartEvent=function findCounterpartEvent(authorityPayload,event,permissibleError,counterpartFileContent){var distance=permissibleError.distance,backDoorEntrance=permissibleError.backDoorEntrance,backDoorExit=permissibleError.backDoorExit,frontDoorEntrance=permissibleError.frontDoorEntrance,frontDoorExit=permissibleError.frontDoorExit,times=permissibleError.times;var result={};var _iterator=_createForOfIteratorHelper(counterpartFileContent),_step;try{for(_iterator.s();!(_step=_iterator.n()).done;){var counterpartPayload=_step.value;var _iterator2=_createForOfIteratorHelper(counterpartPayload.eventos),_step2;try{for(_iterator2.s();!(_step2=_iterator2.n()).done;){var counterpartEvent=_step2.value;if(counterpartEvent.__taken)continue;formatEventData(counterpartEvent);var backDoor=event.puerta.find(function(_ref2){var idPuerta=_ref2.idPuerta;return idPuerta===1;});var frontDoor=event.puerta.find(function(_ref3){var idPuerta=_ref3.idPuerta;return idPuerta===0;});var counterpartBackDoor=counterpartEvent.puerta.find(function(_ref4){var idPuerta=_ref4.idPuerta;return idPuerta===1;});var counterpartFrontDoor=counterpartEvent.puerta.find(function(_ref5){var idPuerta=_ref5.idPuerta;return idPuerta===0;});var timeDiff=parseInt(Math.abs(event.timestamp-counterpartEvent.timestamp)/1000,10);var applyTime=timeDiff<=times;if(!applyTime)continue;var distanceDiff=getDistance({latitude:event.latitud,longitude:event.longitud},{latitude:counterpartEvent.latitud,longitude:counterpartEvent.longitud});var applyDistance=distanceDiff<=distance;if(!applyDistance)continue;var applyBackDoorEntrance=backDoor&&counterpartBackDoor&&Math.abs(backDoor.ingresos-counterpartBackDoor.ingresos)<=backDoorEntrance;var applyBackDoorExit=backDoor&&counterpartBackDoor&&Math.abs(backDoor.salidas-counterpartBackDoor.salidas)<=backDoorExit;var applyFrontDoorEntrance=frontDoor&&counterpartFrontDoor&&Math.abs(frontDoor.ingresos-counterpartFrontDoor.ingresos)<=frontDoorEntrance;var applyFrontDoorExit=frontDoor&&counterpartFrontDoor&&Math.abs(frontDoor.salidas-counterpartFrontDoor.salidas)<=frontDoorExit;var applyFrontDoorState=frontDoor&&counterpartFrontDoor&&frontDoor.estado===counterpartFrontDoor.estado;var applyBackDoorState=backDoor&&counterpartBackDoor&&backDoor.estado===counterpartBackDoor.estado;var dop=counterpartEvent.dop;var ranking=timeDiff+distanceDiff+applyBackDoorEntrance+applyBackDoorExit+applyFrontDoorEntrance+applyFrontDoorExit;if(!result.counterpartEvent||ranking<result.match.ranking){result={counterpartEvent:counterpartEvent,match:{timeDiff:timeDiff,distanceDiff:distanceDiff,ranking:ranking,backDoor:backDoor,counterpartFrontDoor:counterpartFrontDoor,counterpartBackDoor:counterpartBackDoor,frontDoor:frontDoor,applyTime:applyTime,applyDistance:applyDistance,applyBackDoorEntrance:applyBackDoorEntrance,applyBackDoorExit:applyBackDoorExit,applyFrontDoorEntrance:applyFrontDoorEntrance,applyFrontDoorExit:applyFrontDoorExit,applyFrontDoorState:applyFrontDoorState,applyBackDoorState:applyBackDoorState,dop:dop}};}}}catch(err){_iterator2.e(err);}finally{_iterator2.f();}}}catch(err){_iterator.e(err);}finally{_iterator.f();}if(result.counterpartEvent)result.counterpartEvent.__taken=true;return result;};var generateFlagCell=function generateFlagCell(event,counterpartEvent,match){return!match?'ERROR':match.applyBackDoorEntrance&&match.applyBackDoorExit&&match.applyFrontDoorEntrance&&match.applyFrontDoorExit&&match.applyFrontDoorState&&match.applyBackDoorState?'OK':'WARNING';};var generateDateTimeCell=function generateDateTimeCell(event,counterpartEvent,match){var dateTime=new Date(event.timestamp).toLocaleString();if(!match||match.timeDiff===0){return dateTime;}return\"\".concat(dateTime,\" dif:\").concat(match.timeDiff,\"s\");};var generateLocationCell=function generateLocationCell(event,counterpartEvent,match){if(!match||match.distanceDiff===0){return\"\".concat(event.latitud,\",\").concat(event.longitud);}return\"\".concat(event.latitud,\",\").concat(event.longitud,\" dif:\").concat(match.distanceDiff,\"m\");};var generateDoorStateCell=function generateDoorStateCell(event,counterpartEvent,match){if(!match||match.applyFrontDoorState&&match.applyBackDoorState){var backDoor=event.puerta.find(function(_ref6){var idPuerta=_ref6.idPuerta;return idPuerta===1;});var frontDoor=event.puerta.find(function(_ref7){var idPuerta=_ref7.idPuerta;return idPuerta===0;});return\"D\".concat(frontDoor.estado?'C':'A',\"T\").concat(backDoor.estado?'C':'A');}return\"D\".concat(match.frontDoor.estado?'C':'A',\"T\").concat(match.backDoor.estado?'C':'A',\" aut: D\").concat(match.counterpartFrontDoor.estado?'C':'A',\"T\").concat(match.counterpartBackDoor.estado?'C':'A',\" \");};var generateDoorPassengerCell=function generateDoorPassengerCell(event,counterpartEvent,match,isFront,isEntrance){if(!match||match[\"apply\".concat(isFront?'Front':'Back',\"Door\").concat(isEntrance?'Entrance':'Exit')]){var door=event.puerta.find(function(_ref8){var idPuerta=_ref8.idPuerta;return idPuerta===(isFront?0:1);});return\"\".concat(door[isEntrance?'ingresos':'salidas']);}return\"\".concat(match[isFront?'frontDoor':'backDoor'][isEntrance?'ingresos':'salidas'],\" aut:\").concat(match[isFront?'counterpartFrontDoor':'counterpartBackDoor'][isEntrance?'ingresos':'salidas']);};var generateDopCell=function generateDopCell(event,counterpartEvent,match){if(!match||match.dop===0){return\"\".concat(event.dop);}return\"\".concat(event.dop,\"/\").concat(match.dop);};var generateReportTableRow=function generateReportTableRow(event,counterpartEvent,match){var dateTime=new Date(event.timestamp).toLocaleString();return{flag:generateFlagCell(event,counterpartEvent,match),dateTime:generateDateTimeCell(event,counterpartEvent,match),location:generateLocationCell(event,counterpartEvent,match),coordinates:{latitude:event.latitud,longitude:event.longitud},doorState:generateDoorStateCell(event,counterpartEvent,match),// frontDoorPassengerEntrance\nfdpentr:generateDoorPassengerCell(event,counterpartEvent,match,true,true),// frontDoorPassengerExit\nfdpexit:generateDoorPassengerCell(event,counterpartEvent,match,true,false),// backDoorPassengerEntrance\nbdpentr:generateDoorPassengerCell(event,counterpartEvent,match,false,true),// backDoorPassengerExit\nbdpexit:generateDoorPassengerCell(event,counterpartEvent,match,false,false),dop:generateDopCell(event,counterpartEvent,match)};};var buildReportTable=function buildReportTable(appFileContent,authorityVehicleFileContent,analysisParameter){appFileContent=_.cloneDeep(appFileContent);authorityVehicleFileContent=_.cloneDeep(authorityVehicleFileContent);analysisParameter=_.cloneDeep(analysisParameter);var reportTable=[];// final result => output\nvar _iterator3=_createForOfIteratorHelper(appFileContent),_step3;try{for(_iterator3.s();!(_step3=_iterator3.n()).done;){var appRow=_step3.value;var authorityPayload=appRow.authorityPayload;if(!authorityPayload)continue;// ignores text-notes\nvar _iterator4=_createForOfIteratorHelper(authorityPayload.eventos),_step4;try{for(_iterator4.s();!(_step4=_iterator4.n()).done;){var event=_step4.value;formatEventData(event);var radioPermissibleError=findRadioPermissibleError(event.dop,analysisParameter.dopDistancePermissibleErrors);var permissibleError=_objectSpread(_objectSpread({},analysisParameter.permissibleErrors),{},{distance:radioPermissibleError});var _findCounterpartEvent=findCounterpartEvent(authorityPayload,event,permissibleError,authorityVehicleFileContent),counterpartEvent=_findCounterpartEvent.counterpartEvent,match=_findCounterpartEvent.match;reportTable.push(generateReportTableRow(event,counterpartEvent,match));}}catch(err){_iterator4.e(err);}finally{_iterator4.f();}}}catch(err){_iterator3.e(err);}finally{_iterator3.f();}return reportTable;};export default buildReportTable;","map":null,"metadata":{},"sourceType":"module"}
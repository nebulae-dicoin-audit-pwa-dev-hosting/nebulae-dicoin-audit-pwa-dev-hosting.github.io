{"ast":null,"code":"import _objectSpread from\"/Users/sebastianmolano/NebulaE/Projects/GTPC/dicon-audit-pwa/frontend/dicon-audit-pwa/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/objectSpread2\";import _classCallCheck from\"/Users/sebastianmolano/NebulaE/Projects/GTPC/dicon-audit-pwa/frontend/dicon-audit-pwa/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/classCallCheck\";import _createClass from\"/Users/sebastianmolano/NebulaE/Projects/GTPC/dicon-audit-pwa/frontend/dicon-audit-pwa/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/createClass\";import _ from'lodash';import moment from'moment';import RecordDA from'./data-access/RecordDA';import TripDA from'./data-access/TripDA';var Trip=/*#__PURE__*/function(){/**\n   * @param string routeCode\n   * @param string route\n   * @param string vehiclePlate\n   * @param string driverDocument\n   * @param string companyId\n   */function Trip(routeCode,route,vehiclePlate,driverDocument,companyId,errorReporter){_classCallCheck(this,Trip);var args=Array.from(arguments);if(args.lenngth<6||args.some(function(arg){return arg===undefined||arg===null;})){errorReporter('ERROR_MISSING_ARGUMENTS');}else{this.errorReporter=errorReporter;this.routeCode=routeCode;this.route=route;this.vehiclePlate=vehiclePlate;this.driverDocument=driverDocument;this.companyId=companyId;this.tempState=this.buildNewState();this.state=this.buildNewState();this.recordSeq=0;this.records=[];}}_createClass(Trip,[{key:\"updateTrip\",value:function updateTrip(){if(this._id)return TripDA.updateTrip(this._id,{tempState:this.tempState,state:this.state});return null;}},{key:\"buildRecordId\",value:function buildRecordId(){var companyId=(this.companyId||'').replace('-','');var plate=this.vehiclePlate;var currentDate=this.recordSeq===1?new Date(this.state.timestamp):new Date(this.tempState.timestamp);var mm=currentDate.getMonth()+1;var dd=currentDate.getDate();var year=currentDate.getFullYear();var hour=currentDate.getHours();var minutes=currentDate.getMinutes();var seconds=currentDate.getSeconds();var milisegundos=currentDate.getMilliseconds();return\"\".concat(companyId).concat(plate).concat((dd>9?'':'0')+dd).concat((mm>9?'':'0')+mm).concat(year).concat((hour>9?'':'0')+hour).concat((minutes>9?'':'0')+minutes).concat((seconds>9?'':'0')+seconds);}},{key:\"buildNewState\",value:function buildNewState(){var stateToBaseOn=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};var propertiesToSet=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};return _.cloneDeep(_objectSpread(_objectSpread(_objectSpread({geolocationPosition:null,frontDoorOpen:null,backDoorOpen:null,frontDoorInput:0,frontDoorOutput:0,backDoorInput:0,backDoorOutput:0,traveledDistance:0},stateToBaseOn),propertiesToSet),{},{timestamp:Date.now()}));}},{key:\"getAndResetTempState\",value:function getAndResetTempState(){var tempStateToReturn=this.tempState;this.tempState=this.buildNewState(tempStateToReturn,{frontDoorInput:0,frontDoorOutput:0,backDoorInput:0,backDoorOutput:0,traveledDistance:0});this.updateTrip();return tempStateToReturn;}},{key:\"reportGeolocationPosition\",value:function reportGeolocationPosition(geolocationPosition){var geoLoc;var traveledDistance=0;if(geolocationPosition===null||geolocationPosition===undefined){// this.errorReporter('INVALID_GEOLOCATION');\nconsole.log('INVALID_GEOLOCATION.noData',{geolocationPosition:geolocationPosition});}else{var timestamp=geolocationPosition.timestamp,_geolocationPosition$=geolocationPosition.coords,accuracy=_geolocationPosition$.accuracy,altitude=_geolocationPosition$.altitude,altitudeAccuracy=_geolocationPosition$.altitudeAccuracy,dop=_geolocationPosition$.dop,heading=_geolocationPosition$.heading,latitude=_geolocationPosition$.latitude,longitude=_geolocationPosition$.longitude,speed=_geolocationPosition$.speed;var mandatoryProps=[timestamp,latitude,longitude,speed,dop];if(mandatoryProps.some(function(prop){return prop===undefined||prop===null;})){// this.errorReporter('INVALID_GEOLOCATION');\nconsole.log('INVALID_GEOLOCATION.mandatoryProps validation failed:',{timestamp:timestamp,latitude:latitude,longitude:longitude,speed:speed,dop:dop});}else{geoLoc={timestamp:timestamp,coords:{accuracy:accuracy,altitude:altitude,altitudeAccuracy:altitudeAccuracy,dop:dop,heading:heading,latitude:latitude,longitude:longitude,speed:speed}};traveledDistance=((this.tempState||{}).geolocationPosition||{}).coords&&!_.isEqual(((this.tempState||{}).geolocationPosition||{}).coords,geoLoc.coords)?this.distance(geoLoc.coords,((this.tempState||{}).geolocationPosition||{}).coords):0;console.log(\"trip.reportGeolocationPosition\",traveledDistance);}}this.tempState.traveledDistance+=traveledDistance;this.tempState.geolocationPosition=geoLoc;this.state.traveledDistance+=traveledDistance;this.state.geolocationPosition=geoLoc;this.updateTrip();}},{key:\"distance\",value:function distance(coord1,coord2){var _ref=coord1||{},_ref$latitude=_ref.latitude,lat1=_ref$latitude===void 0?0:_ref$latitude,_ref$longitude=_ref.longitude,lon1=_ref$longitude===void 0?0:_ref$longitude;var _ref2=coord2||{},_ref2$latitude=_ref2.latitude,lat2=_ref2$latitude===void 0?0:_ref2$latitude,_ref2$longitude=_ref2.longitude,lon2=_ref2$longitude===void 0?0:_ref2$longitude;if(lat1===lat2&&lon1===lon2){return false;}var radlat1=Math.PI*lat1/180;var radlat2=Math.PI*lat2/180;var theta=lon1-lon2;var radtheta=Math.PI*theta/180;var dist=Math.sin(radlat1)*Math.sin(radlat2)+Math.cos(radlat1)*Math.cos(radlat2)*Math.cos(radtheta);if(dist>1){dist=1;}dist=Math.acos(dist);dist=dist*180/Math.PI;dist=dist*60*1.1515;dist=Math.floor(dist*1.609344*1000);return dist;}},{key:\"reportDoorsStatus\",value:function reportDoorsStatus(frontDoorOpen,backDoorOpen){var args=Array.from(arguments);if(args.lenngth<2||args.some(function(arg){return arg===undefined||arg===null||typeof arg!=='boolean';})){this.errorReporter('INVALID_DOOR_STATUS');}else{this.tempState=_objectSpread(_objectSpread({},this.tempState),{frontDoorOpen:frontDoorOpen,backDoorOpen:backDoorOpen});this.state=_objectSpread(_objectSpread({},this.state),{frontDoorOpen:frontDoorOpen,backDoorOpen:backDoorOpen});this.updateTrip();}}},{key:\"reportTripStoped\",value:function reportTripStoped(reason,endTimestamp){var newData={tripState:'FINALIZED',reason:reason,endTimestamp:endTimestamp};this.tempState=_objectSpread(_objectSpread({},this.tempState),newData);this.state=_objectSpread(_objectSpread({},this.state),newData);this.finalizeTrip(newData);}},{key:\"finalizeTrip\",value:function finalizeTrip(newData){if(this._id)return TripDA.finalizeTrip(this._id,newData);return null;}},{key:\"reportPassengerFlow\",value:function reportPassengerFlow(frontDoorInput,frontDoorOutput,backDoorInput,backDoorOutput){var args=Array.from(arguments);if(args.lenngth<4||args.some(function(arg){return arg===undefined||arg===null||typeof arg!=='number'||arg<0;})){this.errorReporter('INVALID_PASSENGER_FLOW');}else{this.tempState.frontDoorInput+=frontDoorInput;this.tempState.frontDoorOutput+=frontDoorOutput;this.tempState.backDoorInput+=backDoorInput;this.tempState.backDoorOutput+=backDoorOutput;this.state.frontDoorInput+=frontDoorInput;this.state.frontDoorOutput+=frontDoorOutput;this.state.backDoorInput+=backDoorInput;this.state.backDoorOutput+=backDoorOutput;this.updateTrip();}}},{key:\"generateRecord\",value:function generateRecord(){var tempState=this.getAndResetTempState();this.recordSeq+=1;var timestamp=this.recordSeq===1?this.state.timestamp:Date.now();var record={_id:this.buildRecordId(timestamp),state:'PERSISTED',type:'RECORD',recordSeq:this.recordSeq,timestamp:timestamp,tripTempState:tempState,stats:{retryAttempt:0,attempts:[]}};this.records.push(record);var extendedRecord=this.buildRecordAndPersist(record);this.incRecorSeq();return{record:record,extendedRecord:extendedRecord};}},{key:\"generateFinalRecord\",value:function generateFinalRecord(endTimestamp,endState){var tempState=this.getAndResetTempState();this.recordSeq+=1;var timestamp=this.recordSeq===1?this.state.timestamp:Date.now();var record={_id:this.buildRecordId(timestamp),state:'PERSISTED',type:'RECORD',recordSeq:this.recordSeq,endState:endState,endTimestamp:endTimestamp,timestamp:timestamp,tripTempState:tempState,stats:{retryAttempt:0,attempts:[]}};this.records.push(record);var extendedRecord=this.buildRecordAndPersist(record);this.incRecorSeq();return{record:record,extendedRecord:extendedRecord};}},{key:\"incRecorSeq\",value:function incRecorSeq(){if(this._id){TripDA.updateTrip(this._id,{recordSeq:this.recordSeq});}}},{key:\"addNote\",value:function addNote(note){var record={_id:\"\".concat(this.buildRecordId(),\"-NOTE\"),type:'NOTE',timestamp:Date.now(),note:note};this.records.push(record);var extendedRecord=this.buildRecordAndPersist(record);return{record:record,extendedRecord:extendedRecord};}},{key:\"buildRecordAndPersist\",value:function buildRecordAndPersist(record){var state=record.state,_id=record._id,type=record.type,timestamp=record.timestamp,_record$tripTempState=record.tripTempState,tripTempState=_record$tripTempState===void 0?{}:_record$tripTempState,note=record.note,endTimestamp=record.endTimestamp,endState=record.endState;var currentRecord={_id:_id,serviceId:this._id,state:state,type:type,timestamp:timestamp,recordSeq:this.recordSeq,tripState:type==='RECORD'?{endTimestamp:endTimestamp,traveledDistance:this.state.traveledDistance,tempStateTraveledDistance:tripTempState.traveledDistance,tempStateTimestamp:tripTempState.timestamp}:undefined,payload:type==='RECORD'?{geolocationPosition:tripTempState.geolocationPosition,frontDoorInput:tripTempState.frontDoorInput,frontDoorOutput:tripTempState.frontDoorOutput,backDoorInput:tripTempState.backDoorInput,backDoorOutput:tripTempState.backDoorOutput,frontDoorOpen:tripTempState.frontDoorOpen,backDoorOpen:tripTempState.backDoorOpen}:{timestamp:timestamp,note:note},authorityPayload:type==='RECORD'?{idViaje:this._id,cedula:this.driverDocument,codigoRuta:this.route==='NA'?'':this.routeCode,ruta:this.route==='NA'?'NA':this.route,nit:this.companyId,placa:this.vehiclePlate,inicio_viaje:this.route==='NA'?'':moment(this.state.timestamp).format('DD/MM/YYYY HH:mm:ss'),fin_viaje:this.route==='NA'?'':endTimestamp?moment(endTimestamp).format('DD/MM/YYYY HH:mm:ss'):'',estado:this.route==='NA'?'':endState==='S'?'1':'0',eventos:[{fecha:moment(timestamp).format('YYYY/MM/DD').replaceAll('/',''),hora:moment(timestamp).format('HH:mm:ss').replaceAll(':',''),dop:String(tripTempState.geolocationPosition.coords.dop).replaceAll('.',','),longitud:String(tripTempState.geolocationPosition.coords.longitude.toFixed(6)).replaceAll('.',','),latitud:String(tripTempState.geolocationPosition.coords.latitude.toFixed(6)).replaceAll('.',','),velocidad:tripTempState.geolocationPosition.coords.speed,puerta:[{idPuerta:0,estado:tripTempState.frontDoorOpen?0:1,ingresos:tripTempState.frontDoorInput,salidas:tripTempState.frontDoorOutput},{idPuerta:1,estado:tripTempState.backDoorOpen?0:1,ingresos:tripTempState.backDoorInput,salidas:tripTempState.backDoorOutput}]}]}:undefined,stats:type==='RECORD'?{retryAttempt:0,attempts:[]}:undefined};RecordDA.insertRecord(currentRecord);return currentRecord;}}]);return Trip;}();/**\n * @returns {Trip}\n */export default Trip;","map":null,"metadata":{},"sourceType":"module"}
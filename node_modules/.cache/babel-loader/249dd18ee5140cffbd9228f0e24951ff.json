{"ast":null,"code":"import _toConsumableArray from\"/Users/sebastianmolano/NebulaE/Projects/GTPC/dicon-audit-pwa/frontend/dicon-audit-pwa/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/toConsumableArray\";import _objectSpread from\"/Users/sebastianmolano/NebulaE/Projects/GTPC/dicon-audit-pwa/frontend/dicon-audit-pwa/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/objectSpread2\";import _regeneratorRuntime from\"/Users/sebastianmolano/NebulaE/Projects/GTPC/dicon-audit-pwa/frontend/dicon-audit-pwa/node_modules/babel-preset-react-app/node_modules/@babel/runtime/regenerator\";import _createForOfIteratorHelper from\"/Users/sebastianmolano/NebulaE/Projects/GTPC/dicon-audit-pwa/frontend/dicon-audit-pwa/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/createForOfIteratorHelper\";import _asyncToGenerator from\"/Users/sebastianmolano/NebulaE/Projects/GTPC/dicon-audit-pwa/frontend/dicon-audit-pwa/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";import _classCallCheck from\"/Users/sebastianmolano/NebulaE/Projects/GTPC/dicon-audit-pwa/frontend/dicon-audit-pwa/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/classCallCheck\";import _createClass from\"/Users/sebastianmolano/NebulaE/Projects/GTPC/dicon-audit-pwa/frontend/dicon-audit-pwa/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/createClass\";import{Subject,timer}from'rxjs';import{takeUntil,tap}from'rxjs/operators';import _ from'lodash';import pako from'pako';import Trip from'./Trip';import TransmissionConfig from'./TransmissionConfig';import RecordGenerationRules from'./RecordGenerationRules';import RecordTransmitter from'./RecordTransmitter';import EVENT_TYPES from'./EventTypes';import{MinimongoDB}from'./MinimongoDB/MinimongoDB';import TripDA from'./data-access/TripDA';import RecordDA from'./data-access/RecordDA';var Dicoin=/*#__PURE__*/function(){function Dicoin(){var _this=this;_classCallCheck(this,Dicoin);this.eventListeners={};this.records$=new Subject();this.stopSubject$=new Subject();this.stopTransmissionSubject$=new Subject();this.recordTransmitter=new RecordTransmitter(this);this.db=new MinimongoDB(['Trip','Record'],function(){_this.emitEvent(EVENT_TYPES.DB_STARTED);});}_createClass(Dicoin,[{key:\"tripErrorReporter\",value:function tripErrorReporter(msg){this.emitEvent(EVENT_TYPES.ERROR_REPORTED,{message:msg});}},{key:\"clearTrip\",value:function clearTrip(){this.trip.records=[];this.tripStarted=false;this.recordTransmisionStarted=false;this.trip=null;this.transmissionConfig=null;this.recordGenerationRules=null;this.emitEvent(EVENT_TYPES.TRIP_REMOVED,{});TripDA.removeTrip();RecordDA.removeRecords();}/*\n   *******************************\n   *** RECOVER PERSISTED STATE ***\n   *******************************\n   */},{key:\"recoverPersistedState\",value:function(){var _recoverPersistedState=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(){var _this2=this;var prevTrip,routeCode,route,vehiclePlate,driverDocument,companyId,state,tempState,recordSeq,transmissionConfig,recordGenerationRules,_id,_ref,online,endPoint,user,password,maxRetries,delayBetweenRetries,_ref2,distanceThreshold,timeThreshold,speedThreshold,useDoorStateAsTrigger,prevRecords,_iterator,_step,currentRecord,normalizedRecord;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:_context.next=2;return TripDA.getPrevTrip().then(function(r){return r;});case 2:prevTrip=_context.sent;if(!prevTrip){_context.next=26;break;}routeCode=prevTrip.routeCode,route=prevTrip.route,vehiclePlate=prevTrip.vehiclePlate,driverDocument=prevTrip.driverDocument,companyId=prevTrip.companyId,state=prevTrip.state,tempState=prevTrip.tempState,recordSeq=prevTrip.recordSeq,transmissionConfig=prevTrip.transmissionConfig,recordGenerationRules=prevTrip.recordGenerationRules,_id=prevTrip._id;// creo el trip\nthis.trip=new Trip(routeCode,route,vehiclePlate,driverDocument,companyId,function(msg){_this2.emitEvent(EVENT_TYPES.ERROR_REPORTED,{message:msg});});this.trip.tempState=tempState;this.trip.state=state||{};this.trip.state.endTimestamp=prevTrip.endTimestamp;this.tripStarted=true;// seteo el Id del trip  y recordSeq\nthis.trip._id=_id;this.trip.recordSeq=recordSeq;// seteo las reglas y configuraciones\n_ref=transmissionConfig||{},online=_ref.online,endPoint=_ref.endPoint,user=_ref.user,password=_ref.password,maxRetries=_ref.maxRetries,delayBetweenRetries=_ref.delayBetweenRetries;_ref2=recordGenerationRules||{},distanceThreshold=_ref2.distanceThreshold,timeThreshold=_ref2.timeThreshold,speedThreshold=_ref2.speedThreshold,useDoorStateAsTrigger=_ref2.useDoorStateAsTrigger;this.transmissionConfig=new TransmissionConfig(online,endPoint,user,password,maxRetries,delayBetweenRetries,function(msg){_this2.emitEvent(EVENT_TYPES.ERROR_REPORTED,{message:msg});});if(prevTrip.tripState!=='FINALIZED'){this.startRecordGenerationByTime();}if(this.transmissionConfig.online){this.recordTransmitter.startRecordTransmission();}this.emitEvent(EVENT_TYPES.TRIP_TYPE_REPORTED,{online:online});this.recordGenerationRules=new RecordGenerationRules(distanceThreshold,timeThreshold,speedThreshold,useDoorStateAsTrigger,(recordGenerationRules||{}).accumulatorTimeThreshold||2000,function(msg){_this2.emitEvent(EVENT_TYPES.ERROR_REPORTED,{message:msg});});this.trip.transmissionConfig=this.transmissionConfig;this.trip.recordGenerationRules=this.recordGenerationRules;this.emitEvent(EVENT_TYPES.TRIP_LOADED,{tempState:this.trip.tempState,state:this.trip.state,tripState:prevTrip.tripState,reason:prevTrip.reason});// obtengo los records de ese trip\n_context.next=24;return RecordDA.getPrevRecords(prevTrip._id).then(function(r){return r;});case 24:prevRecords=_context.sent;if(prevRecords&&prevRecords.length>0){this.trip.records=[];_iterator=_createForOfIteratorHelper(prevRecords);try{for(_iterator.s();!(_step=_iterator.n()).done;){currentRecord=_step.value;normalizedRecord=currentRecord;if(currentRecord.type==='RECORD'){normalizedRecord={_id:currentRecord._id,state:currentRecord.state,type:currentRecord.type,recordSeq:currentRecord.recordSeq,endState:currentRecord.endState,endTimestamp:currentRecord.tripState.endTimestamp,timestamp:currentRecord.timestamp,tripTempState:{geolocationPosition:currentRecord.payload.geolocationPosition,frontDoorOpen:currentRecord.payload.frontDoorOpen,backDoorOpen:currentRecord.payload.backDoorOpen,frontDoorInput:currentRecord.payload.frontDoorInput,frontDoorOutput:currentRecord.payload.frontDoorOutput,backDoorInput:currentRecord.payload.backDoorInput,backDoorOutput:currentRecord.payload.backDoorOutput,traveledDistance:currentRecord.tripState.tempStateTraveledDistance,timestamp:currentRecord.tripState.timestamp},stats:currentRecord.stats};}else{normalizedRecord={_id:currentRecord._id,type:currentRecord.type,timestamp:currentRecord.timestamp,note:currentRecord.payload.note};}if(currentRecord.type==='RECORD'&&currentRecord.state!=='SENT'&&normalizedRecord.stats.retryAttempt<this.transmissionConfig.maxRetries){this.records$.next({localRecord:normalizedRecord,extendedRecord:currentRecord});}this.trip.records.push(normalizedRecord);}}catch(err){_iterator.e(err);}finally{_iterator.f();}this.emitEvent(EVENT_TYPES.RECORD_GENERATED,{records:this.trip.records});}case 26:case\"end\":return _context.stop();}}},_callee,this);}));function recoverPersistedState(){return _recoverPersistedState.apply(this,arguments);}return recoverPersistedState;}()},{key:\"reportTripState\",value:function(){var _reportTripState=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee2(){var prevTrip,prevRecords,recordsLength,firstRecord,lastRecord,base,_iterator2,_step2,record,eventos;return _regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:_context2.next=2;return TripDA.getPrevTrip().then(function(r){return r;});case 2:prevTrip=_context2.sent;if(!prevTrip){_context2.next=8;break;}_context2.next=6;return RecordDA.getPrevRecords(prevTrip._id).then(function(r){return r;});case 6:prevRecords=_context2.sent;if(prevRecords&&prevRecords.length>0){recordsLength=prevRecords.length;firstRecord=prevRecords[0];lastRecord=prevRecords[recordsLength-1];base=_objectSpread(_objectSpread({},firstRecord.authorityPayload),{},{stats:undefined,eventos:[],estado:lastRecord.authorityPayload.estado,fin_viaje:lastRecord.authorityPayload.fin_viaje});_iterator2=_createForOfIteratorHelper(prevRecords);try{for(_iterator2.s();!(_step2=_iterator2.n()).done;){record=_step2.value;eventos=record.authorityPayload.eventos;base.eventos=[].concat(_toConsumableArray(base.eventos),_toConsumableArray(eventos));}}catch(err){_iterator2.e(err);}finally{_iterator2.f();}this.recordTransmitter.sendTripOnBatch(firstRecord._id,base);}case 8:case\"end\":return _context2.stop();}}},_callee2,this);}));function reportTripState(){return _reportTripState.apply(this,arguments);}return reportTripState;}()},{key:\"generateContentReport\",value:function(){var _generateContentReport=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee3(){var prevTrip,prevRecords,dataAsString,dataDeflated,dataAsBase64,blobFile;return _regeneratorRuntime.wrap(function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:_context3.next=2;return TripDA.getPrevTrip().then(function(r){return r;});case 2:prevTrip=_context3.sent;if(!prevTrip){_context3.next=8;break;}_context3.next=6;return RecordDA.getPrevRecords(prevTrip._id).then(function(r){return r;});case 6:prevRecords=_context3.sent;if(prevRecords&&prevRecords.length>0){dataAsString=JSON.stringify(prevRecords);dataDeflated=pako.deflate(dataAsString);dataAsBase64=Buffer.from(dataDeflated).toString('base64');blobFile=new Blob([dataAsBase64],{type:'text/plain'});this.emitEvent(EVENT_TYPES.TRIP_REPORT_GENERATED,{reportContent:blobFile,fileName:\"\".concat(prevTrip._id,\".neb\")});}case 8:case\"end\":return _context3.stop();}}},_callee3,this);}));function generateContentReport(){return _generateContentReport.apply(this,arguments);}return generateContentReport;}()/*\n   ***************************************************************************\n   *** START/STOP TRIP + ADD/REMOVE/SEND EVENT-LISTENER  + GET-STATE-CLONE ***\n   ***************************************************************************\n   */ /**\n   * Starts a new Trip\n   * @param {Trip} trip\n   * @param {RecordGenerationRules} recordGenerationRules\n   * @param {TransmissionConfig} transmissionConfig\n   */},{key:\"startTrip\",value:function(){var _startTrip=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee4(trip,transmissionConfig,recordGenerationRules){var args,wasTripPersisted,_args4=arguments;return _regeneratorRuntime.wrap(function _callee4$(_context4){while(1){switch(_context4.prev=_context4.next){case 0:if(!this.tripStarted){_context4.next=4;break;}this.emitEvent(EVENT_TYPES.ERROR_REPORTED,{message:'ERROR_TRIP_ALREADY_STARTED'});_context4.next=24;break;case 4:if(!this.recordTransmisionStarted){_context4.next=8;break;}this.emitEvent(EVENT_TYPES.ERROR_REPORTED,{message:'ERROR_RECORDS_PENDING_FOR_TRANSMISSIONT'});_context4.next=24;break;case 8:args=Array.from(_args4);if(!(args.lenngth<3||args.some(function(arg){return arg===undefined||arg===null;}))){_context4.next=13;break;}this.emitEvent(EVENT_TYPES.ERROR_REPORTED,{message:'ERROR_MISSING_ARGUMENTS'});_context4.next=24;break;case 13:this.trip=_.cloneDeep(trip);this.trip._id=this.buildTripId();this.transmissionConfig=_.cloneDeep(transmissionConfig);this.recordGenerationRules=_.cloneDeep(recordGenerationRules);this.trip.transmissionConfig=this.transmissionConfig;this.trip.recordGenerationRules=this.recordGenerationRules;this.tripStarted=true;_context4.next=22;return this.buildTripAndPersist().then(function(r){return r;});case 22:wasTripPersisted=_context4.sent;if(!wasTripPersisted){this.emitEvent(EVENT_TYPES.ERROR_REPORTED,{message:'ERROR_TRIṔ_COULD_NOT_BE_PERSISTED'});}else{this.startRecordGenerationByTime();if(this.transmissionConfig.online){this.recordTransmitter.startRecordTransmission();}this.emitEvent(EVENT_TYPES.TRIP_STARTED,{tempState:this.trip.tempState,state:this.trip.state});}case 24:case\"end\":return _context4.stop();}}},_callee4,this);}));function startTrip(_x,_x2,_x3){return _startTrip.apply(this,arguments);}return startTrip;}()},{key:\"buildTripId\",value:function buildTripId(){var companyId=this.trip.companyId.replace('-','');var plate=this.trip.vehiclePlate;var currentDate=new Date(this.trip.state.timestamp);var mm=currentDate.getMonth()+1;var dd=currentDate.getDate();var year=currentDate.getFullYear();var hour=currentDate.getHours();var minutes=currentDate.getMinutes();var seconds=currentDate.getSeconds();var milisegundos=currentDate.getMilliseconds();// return `0-${companyId}-${plate}-${(dd > 9 ? '' : '0') + dd}${(mm > 9 ? '' : '0') + mm}${year}-${\n//   (hour > 9 ? '' : '0') + hour\n// }${(minutes > 9 ? '' : '0') + minutes}${(seconds > 9 ? '' : '0') + seconds}-${milisegundos}`;\nreturn\"0-\".concat(companyId,\"-\").concat((dd>9?'':'0')+dd).concat((mm>9?'':'0')+mm).concat(year,\"-\").concat((hour>9?'':'0')+hour).concat((minutes>9?'':'0')+minutes).concat((seconds>9?'':'0')+seconds,\"-00\").concat(milisegundos);}},{key:\"buildTripAndPersist\",value:function(){var _buildTripAndPersist=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee5(){var currentTrip,insertResult;return _regeneratorRuntime.wrap(function _callee5$(_context5){while(1){switch(_context5.prev=_context5.next){case 0:currentTrip={_id:this.trip._id,routeCode:this.trip.routeCode,route:this.trip.route,vehiclePlate:this.trip.vehiclePlate,driverDocument:this.trip.driverDocument,companyId:this.trip.companyId,state:this.trip.state,tempState:this.trip.tempState,recordSeq:this.trip.recordSeq,transmissionConfig:this.trip.transmissionConfig,recordGenerationRules:this.trip.recordGenerationRules};_context5.next=3;return TripDA.insertTrip(currentTrip).then(function(r){return r;});case 3:insertResult=_context5.sent;return _context5.abrupt(\"return\",insertResult);case 5:case\"end\":return _context5.stop();}}},_callee5,this);}));function buildTripAndPersist(){return _buildTripAndPersist.apply(this,arguments);}return buildTripAndPersist;}()},{key:\"stopTrip\",value:function stopTrip(reason){var stopTransmission=arguments.length>1&&arguments[1]!==undefined?arguments[1]:false;var finalize=arguments.length>2&&arguments[2]!==undefined?arguments[2]:false;if(this.trip&&this.trip._id&&this.trip.tempState&&this.trip.state&&this.trip.tempState.geolocationPosition&&this.trip.records){var endTimestamp=Date.now();if(finalize){var _this$trip$generateFi=this.trip.generateFinalRecord(endTimestamp,reason),record=_this$trip$generateFi.record,extendedRecord=_this$trip$generateFi.extendedRecord;this.records$.next({localRecord:record,extendedRecord:extendedRecord});this.emitEvent(EVENT_TYPES.RECORD_GENERATED,{records:this.trip.records,record:record});this.records$.next('STOPPED');this.trip.reportTripStoped(reason,endTimestamp);this.tripStarted=false;}this.stopSubject$.next({});this.emitEvent(EVENT_TYPES.TRIP_STOPPED,{tempState:this.trip.tempState,state:this.trip.state});if(stopTransmission)this.stopTransmissionSubject$.next({});Dicoin.log('stopped');}}},{key:\"addListener\",value:function addListener(key,onEvent){this.eventListeners[key]=onEvent;}},{key:\"removeListener\",value:function removeListener(key){delete this.eventListeners[key];}},{key:\"emitEvent\",value:function emitEvent(type,payload){Object.values(this.eventListeners).forEach(function(onEvent){return onEvent({type:type,payload:payload});});}},{key:\"getStateClone\",value:function getStateClone(){return _.cloneDeep({trip:this.trip,transmissionConfig:this.transmissionConfig,recordGenerationRules:this.recordGenerationRules});}/*\n   ************************\n   *** RECORD GENERATOR ***\n   ************************\n   */},{key:\"startRecordGenerationByTime\",value:function startRecordGenerationByTime(){var _this3=this;timer(1000,1000).pipe(tap(function(){return _this3.evalTimeOnlyAndGenerateRecord();}),takeUntil(this.stopSubject$)).subscribe(function(evt){// Dicoin.log('startRecordGenerationByTime evt = ', evt);\n},function(err){return console.error('RecordGenerationByTime.ERR',err);},function(){Dicoin.log('STOPPED RecordGenerationByTime');_this3.tripStarted=false;});}},{key:\"evalAndGenerateRecord\",value:function evalAndGenerateRecord(){var doorStateChanged=arguments.length>0&&arguments[0]!==undefined?arguments[0]:false;var _this$recordGeneratio=this.recordGenerationRules,distanceThreshold=_this$recordGeneratio.distanceThreshold,timeThreshold=_this$recordGeneratio.timeThreshold,speedThreshold=_this$recordGeneratio.speedThreshold,useDoorStateAsTrigger=_this$recordGeneratio.useDoorStateAsTrigger;var tripTempState=this.trip.tempState;var _ref3=(tripTempState.geolocationPosition||{}).coords||{},speed=_ref3.speed;speed=speed===undefined?speed:Dicoin.metersPerSecondToKilometersPerHour(speed);var triggeredbyDoors=doorStateChanged&&useDoorStateAsTrigger;var triggeredbyDistance=tripTempState.traveledDistance>=distanceThreshold;console.log('evalAndGenerateRecord',{triggeredbyDistance:triggeredbyDistance,traveledDistance:tripTempState.traveledDistance,distanceThreshold:distanceThreshold});var triggeredbyTime=Date.now()-tripTempState.timestamp>=timeThreshold;var triggeredbySpeed=speed<=speedThreshold;if(triggeredbyDoors||triggeredbyDistance||triggeredbyTime||triggeredbySpeed){this.generateRecord({triggeredbyDoors:triggeredbyDoors,triggeredbyDistance:triggeredbyDistance,triggeredbyTime:triggeredbyTime,triggeredbySpeed:triggeredbySpeed});}}},{key:\"evalTimeOnlyAndGenerateRecord\",value:function evalTimeOnlyAndGenerateRecord(){var timeThreshold=this.recordGenerationRules.timeThreshold;var tripTempState=this.trip.tempState;var triggeredbyTime=Date.now()-tripTempState.timestamp>=timeThreshold;if(triggeredbyTime){this.evalAndGenerateRecord();this.emitEvent(EVENT_TYPES.TRIP_STATE_CHANGED,{tempState:this.trip.tempState,state:this.trip.state});}}},{key:\"generateRecord\",value:function generateRecord(reasons){Dicoin.log('generateRecord',\"reason=\".concat(JSON.stringify(reasons)));if(this.trip.tempState.geolocationPosition){var _this$trip$generateRe=this.trip.generateRecord(),record=_this$trip$generateRe.record,extendedRecord=_this$trip$generateRe.extendedRecord;this.records$.next({localRecord:record,extendedRecord:extendedRecord});this.emitEvent(EVENT_TYPES.RECORD_GENERATED,{records:this.trip.records,record:record});}}},{key:\"getRecordAttemptsLatencyAverage\",value:function getRecordAttemptsLatencyAverage(record){var attepms=record.stats.attempts||[];var attempsLength=attepms.length;var latencyTotal=attepms.reduce(function(acc,val){return acc+(val.latency||0);},0);return latencyTotal&&attempsLength?latencyTotal/attempsLength:0;}},{key:\"getRecordAttemptsLatencySum\",value:function getRecordAttemptsLatencySum(record){var attepms=record.stats.attempts||[];if(attepms.length===0)return'--';var latencyTotal=attepms.reduce(function(acc,val){return acc+(val.latency||0);},0);return latencyTotal;}},{key:\"addNote\",value:function addNote(noteContent){var note=this.trip.addNote(noteContent);this.emitEvent(EVENT_TYPES.NOTE_ADDED,{records:this.trip.records,note:note});}/*\n   *************************************************\n   ********** TRIP REPORT FORWARDS *****************\n   *************************************************\n   */},{key:\"reportGeolocationPosition\",value:function reportGeolocationPosition(geolocationPosition){console.log(\"reportGeolocationPosition\",geolocationPosition);this.trip.reportGeolocationPosition(geolocationPosition);// this.evalAndGenerateRecord();\nthis.emitEvent(EVENT_TYPES.TRIP_STATE_CHANGED,{tempState:this.trip.tempState,state:this.trip.state});}},{key:\"reportDoorsStatus\",value:function reportDoorsStatus(frontDoorOpen,backDoorOpen){if(this.trip.state.frontDoorOpen!==frontDoorOpen||this.trip.state.backDoorOpen!==backDoorOpen)this.trip.reportDoorsStatus(frontDoorOpen,backDoorOpen);this.evalAndGenerateRecord(true);this.emitEvent(EVENT_TYPES.TRIP_STATE_CHANGED,{tempState:this.trip.tempState,state:this.trip.state});}},{key:\"reportPassengerFlow\",value:function reportPassengerFlow(frontDoorInput,frontDoorOutput,backDoorInput,backDoorOutput){if(this.trip){this.trip.reportPassengerFlow(frontDoorInput,frontDoorOutput,backDoorInput,backDoorOutput);this.emitEvent(EVENT_TYPES.TRIP_STATE_CHANGED,{tempState:this.trip.tempState,state:this.trip.state});}}/*\n   *************************************************\n   ****************** TOOLS ************************\n   *************************************************\n   */}],[{key:\"log\",value:function log(){var _console;for(var _len=arguments.length,data=new Array(_len),_key=0;_key<_len;_key++){data[_key]=arguments[_key];}(_console=console).log.apply(_console,['Dicoin:'].concat(data));}},{key:\"metersPerSecondToKilometersPerHour\",value:function metersPerSecondToKilometersPerHour(metersPerSecond){return parseInt(3.6*metersPerSecond,10);}}]);return Dicoin;}();/**\n * @returns {Dicoin}\n */export default Dicoin;","map":null,"metadata":{},"sourceType":"module"}
{"ast":null,"code":"import _classCallCheck from\"/Users/sebastianmolano/NebulaE/Projects/GTPC/dicon-audit-pwa/frontend/dicon-audit-pwa/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/classCallCheck\";import _createClass from\"/Users/sebastianmolano/NebulaE/Projects/GTPC/dicon-audit-pwa/frontend/dicon-audit-pwa/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/createClass\";import{timer,of,from,throwError}from'rxjs';import{takeUntil,delay,tap,concatMap,takeWhile,map,catchError,retryWhen}from'rxjs/operators';import ProxyService from'../../../../services/proxy-service';import RecordDA from'./data-access/RecordDA';import EVENT_TYPES from'./EventTypes';var RecordTransmitter=/*#__PURE__*/function(){function RecordTransmitter(dicoin){_classCallCheck(this,RecordTransmitter);this.dicoin=dicoin;}_createClass(RecordTransmitter,[{key:\"startRecordTransmission\",value:function startRecordTransmission(){var _this=this;this.dicoin.recordTransmisionStarted=true;var retryOptions={maxRetryAttempts:this.dicoin.transmissionConfig.maxRetries,delayDuration:this.dicoin.transmissionConfig.delayBetweenRetries,excludedStatusCodes:[]};this.dicoin.records$.pipe(takeUntil(this.dicoin.stopTransmissionSubject$),// this is only used when the component will be destroyed\nconcatMap(function(record){return of(record).pipe(takeWhile(function(possibleStopFlagDisguisedAsRecord){return possibleStopFlagDisguisedAsRecord!=='STOPPED';}// this happens when the las record has been reached\n),delay(10000),// TODO REQUEST\nconcatMap(function(_ref){var localRecord=_ref.localRecord,extendedRecord=_ref.extendedRecord;var _this$dicoin$transmis=_this.dicoin.transmissionConfig,endPoint=_this$dicoin$transmis.endPoint,user=_this$dicoin$transmis.user,password=_this$dicoin$transmis.password,timeout=_this$dicoin$transmis.timeout;var fileContent=extendedRecord.authorityPayload,fileName=extendedRecord._id;var sendTs=Date.now();return from(ProxyService.send(endPoint,user,password,fileName,JSON.stringify(fileContent),timeout)).pipe(catchError(function(proxyError){RecordTransmitter.logRecordTransmitter('=== THROW ERR proxyError ===========',localRecord.stats.retryAttempt);var dataReturn={localRecord:localRecord,extendedRecord:extendedRecord,sendTs:sendTs,// TODO: Cambiar esto por lo real\nresponse:{statusCode:proxyError.status,ts:Date.now(),message:proxyError.statusText,latency:proxyError.latency}};if(localRecord.stats.retryAttempt<_this.dicoin.transmissionConfig.maxRetries){throw dataReturn;}return of(dataReturn);}),map(function(proxyResponse){var dataReturn={localRecord:localRecord,extendedRecord:extendedRecord,sendTs:sendTs,// TODO: Cambiar esto por lo real\nresponse:{statusCode:proxyResponse.data.statusDTO.codigo,ts:Date.now(),message:proxyResponse.data.statusDTO.descripcion,latency:proxyResponse.data.latency}};var success=proxyResponse.data&&proxyResponse.data.statusDTO&&proxyResponse.data.statusDTO.codigo>=0;if(!success&&localRecord.stats.retryAttempt<=_this.dicoin.transmissionConfig.maxRetries){RecordTransmitter.log('=== THROW ERR proxyResponse ===========',proxyResponse);throw dataReturn;}return dataReturn;}),map(function(_ref2){var response=_ref2.response;var retryAttempt=localRecord.stats.retryAttempt+1;var statusCode=response.statusCode,message=response.message,responseTs=response.ts;var state=statusCode>=0?'SENT':localRecord.stats.attempts<retryOptions.maxRetryAttempts?'WARNING':'ERROR';// Update Local Data\nlocalRecord.state=state;localRecord.stats.attempts.push({code:statusCode,message:message,timestamp:sendTs,latency:response.latency});localRecord.stats.retryAttempt=retryAttempt;localRecord.stats.sentTimestamp=sendTs;// Update DB\nextendedRecord.state=state;extendedRecord.stats.attempts.push({code:statusCode,message:message,timestamp:sendTs,latency:response.latency});extendedRecord.stats.retryAttempt=retryAttempt;extendedRecord.stats.sentTimestamp=sendTs;RecordDA.insertRecord(extendedRecord);var currentRecordIndex=_this.dicoin.trip.records.findIndex(function(rec){return rec._id===extendedRecord._id;});_this.dicoin.trip.records[currentRecordIndex]=localRecord;return localRecord;}),retryWhen(function(attempts$){return _this.retryStrategy(attempts$,retryOptions);}),catchError(function(x){RecordTransmitter.log('=== CATCH_ERROR ===========',x);return of(record);}));}),tap(function(x){RecordTransmitter.log('=======================');RecordTransmitter.log(x);RecordTransmitter.log('=======================');}),tap(function(transmittedRecord){var currentRecordIndex=_this.dicoin.trip.records.findIndex(function(rec){return rec._id===transmittedRecord._id;});_this.dicoin.trip.records[currentRecordIndex]=transmittedRecord;_this.dicoin.emitEvent(EVENT_TYPES.RECORD_UPDATED,{record:transmittedRecord,records:_this.dicoin.trip.records});}));})).subscribe(function(record){RecordTransmitter.log('record transmission:',JSON.stringify(record));},function(err){RecordTransmitter.log('RECORD TRANSMISSION ERROR = ',err);},function(){RecordTransmitter.log('RECORD TRANSMISSION STOPPED');_this.dicoin.recordTransmisionStarted=false;_this.dicoin.emitEvent(EVENT_TYPES.RECORD_TRANSMISSION_STOPPED);});}},{key:\"retryStrategy\",value:function retryStrategy(attempts$,_ref3){var _this2=this;var _ref3$maxRetryAttempt=_ref3.maxRetryAttempts,maxRetryAttempts=_ref3$maxRetryAttempt===void 0?this.dicoin.transmissionConfig.maxRetries:_ref3$maxRetryAttempt,_ref3$delayDuration=_ref3.delayDuration,delayDuration=_ref3$delayDuration===void 0?this.dicoin.transmissionConfig.delayBetweenRetries:_ref3$delayDuration,_ref3$excludedStatusC=_ref3.excludedStatusCodes,excludedStatusCodes=_ref3$excludedStatusC===void 0?[]:_ref3$excludedStatusC;return attempts$.pipe(concatMap(function(_ref4,i){var response=_ref4.response,localRecord=_ref4.localRecord,extendedRecord=_ref4.extendedRecord,sendTs=_ref4.sendTs;var retryAttempt=i+1;if(retryAttempt>maxRetryAttempts||excludedStatusCodes.find(function(e){return e===localRecord.status;})||localRecord.state==='SENT'){console.log('LOOP_INFINITO',extendedRecord._id,{retryAttempt:retryAttempt,maxRetryAttempts:maxRetryAttempts,delayDuration:delayDuration,cond1:retryAttempt>maxRetryAttempts,cond2:excludedStatusCodes.find(function(e){return e===localRecord.status;}),state:localRecord.state});return throwError({response:response,localRecord:localRecord,extendedRecord:extendedRecord,sendTs:sendTs});}var statusCode=response.statusCode,_response$body=response.body,body=_response$body===void 0?{}:_response$body,responseTs=response.ts,message=response.message;var state=localRecord.stats.attempts<maxRetryAttempts?'WARNING':'ERROR';// Update Local Data\nif(localRecord.state!=='SENT'){localRecord.state=state;localRecord.stats.attempts.push({code:statusCode,message:message,timestamp:sendTs,latency:responseTs-sendTs});localRecord.stats.retryAttempt=retryAttempt;localRecord.stats.sentTimestamp=sendTs;}// Update DB\nif(extendedRecord.state!=='SENT'){extendedRecord.state=state;extendedRecord.stats.attempts.push({code:statusCode,message:message,timestamp:sendTs,latency:responseTs-sendTs});extendedRecord.stats.retryAttempt=retryAttempt;extendedRecord.stats.sentTimestamp=sendTs;RecordDA.insertRecord(extendedRecord);}var currentRecordIndex=_this2.dicoin.trip.records.findIndex(function(rec){return rec._id===extendedRecord._id;});_this2.dicoin.trip.records[currentRecordIndex]=localRecord;RecordTransmitter.log(\"Send record Attempt \".concat(retryAttempt,\": retrying in \").concat(delayDuration,\"ms\"));_this2.dicoin.emitEvent(EVENT_TYPES.RECORD_UPDATED,{record:localRecord,records:_this2.dicoin.trip.records});return timer(delayDuration);}));}},{key:\"sendTripOnBatch\",value:function sendTripOnBatch(fileName,fileContent){var _this3=this;var _this$dicoin$transmis2=this.dicoin.transmissionConfig,endPoint=_this$dicoin$transmis2.endPoint,user=_this$dicoin$transmis2.user,password=_this$dicoin$transmis2.password,timeout=_this$dicoin$transmis2.timeout;var sendTs=Date.now();from(ProxyService.send(endPoint,user,password,fileName,JSON.stringify(fileContent),timeout)).pipe(catchError(function(proxyError){var dataReturn={sendTs:sendTs,response:{statusCode:proxyError.status,ts:Date.now(),message:proxyError.statusText,latency:proxyError.latency}};throw dataReturn;}),map(function(proxyResponse){var dataReturn={sendTs:sendTs,response:{statusCode:proxyResponse.data.statusDTO.codigo,ts:Date.now(),message:proxyResponse.data.statusDTO.descripcion,latency:proxyResponse.data.latency}};var success=proxyResponse.data&&proxyResponse.data.statusDTO&&proxyResponse.data.statusDTO.codigo>=0;if(!success){throw dataReturn;}return dataReturn;}),tap(function(transmittedRecord){_this3.dicoin.emitEvent(EVENT_TYPES.TRIP_REPORTED,{});// REPORT TRANSMITTED\n}),catchError(function(error){_this3.dicoin.emitEvent(EVENT_TYPES.ERROR_REPORTED,{message:\"No se pudo reportar: \".concat(error.response.statusCode,\" \").concat(error.response.message)});return of('Error');})).subscribe(function(record){RecordTransmitter.log('record transmission:',JSON.stringify(record));},function(err){RecordTransmitter.log('RECORD TRANSMISSION ERROR = ',err);},function(){RecordTransmitter.log('RECORD TRANSMISSION STOPPED');_this3.dicoin.recordTransmisionStarted=false;_this3.dicoin.emitEvent(EVENT_TYPES.RECORD_TRANSMISSION_STOPPED);});}/*\n   *************************************************\n   ****************** TOOLS ************************\n   *************************************************\n   */}],[{key:\"log\",value:function log(){var _console;for(var _len=arguments.length,data=new Array(_len),_key=0;_key<_len;_key++){data[_key]=arguments[_key];}(_console=console).log.apply(_console,['Dicoin.RecordTransmitter:'].concat(data));}}]);return RecordTransmitter;}();/**\n * @returns {RecordTransmitter}\n */export default RecordTransmitter;","map":null,"metadata":{},"sourceType":"module"}